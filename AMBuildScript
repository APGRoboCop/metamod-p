# AMBuildScript for metamod-p
# vim: set sts=4 ts=8 sw=4 tw=99 et ft=python:
import os, sys

# Force GCC on Linux for legacy support - [APG]RoboCop[CL]
if sys.platform.startswith('linux'):
    os.environ['CC'] = 'gcc'
    os.environ['CXX'] = 'g++'

builder.cxx = builder.DetectCxx(target_arch = 'x86')

# Include search paths
include_paths = [
  os.path.join(builder.currentSourcePath, 'hlsdk', 'common'),
  os.path.join(builder.currentSourcePath, 'hlsdk', 'dlls'),
  os.path.join(builder.currentSourcePath, 'hlsdk', 'engine'),
  os.path.join(builder.currentSourcePath, 'hlsdk', 'pm_shared'),
  os.path.join(builder.currentSourcePath, 'metamod'),
]

builder.cxx.defines += ['AMBUILD', '__METAMOD_BUILD__']

# Add any extra C++/C flags that were passed.
if builder.options.extra_cppflags:
  flags = builder.options.extra_cppflags.split()
  builder.cxx.cflags += flags
  builder.cxx.cxxflags += flags

# Compiler setup
if builder.cxx.target.platform == 'linux':
  # Linux defines
  builder.cxx.defines += ['_LINUX', 'POSIX', 'LINUX', 'linux', '_FORTIFY_SOURCE=2']
  # Linux compiler C flags
  builder.cxx.cflags += [
    '-pipe',
    '-msse',
    '-msse2',
    '-mfpmath=sse',
    '-fno-strict-aliasing',
    '-fno-exceptions',
    '-fno-rtti',
    '-fvisibility=hidden',
    '-fvisibility-inlines-hidden',
    '-ffunction-sections',
    '-fdata-sections',
    '-fstack-protector-strong',
    '-Wall',
    '-Werror',
    '-Wformat',
    '-Wformat-security',
    '-Wno-uninitialized',
    '-Wno-unused',
    '-Wno-switch',
    '-m32',
  ]
  # GCC-specific warning suppressions
  if builder.cxx.like('gcc'):
    builder.cxx.cflags += [
      '-Wno-attributes',
      '-Wno-dangling-pointer',
    ]
  # Clang-specific warning suppressions
  if builder.cxx.like('clang'):
    builder.cxx.cflags += [
      '-Wno-unknown-attributes',
      '-Wno-logical-op-parentheses',
      '-Wno-return-stack-address',
      '-Wno-string-plus-int',
    ]
  # Linux compiler C++ flags
  builder.cxx.cxxflags += [
    '-Wno-invalid-offsetof',
    '-Wno-write-strings',
    '-std=c++17',
  ]
  # TODO: Not important but maybe add AMD64 -m64 compile flag
  # Linux linker flags
  builder.cxx.linkflags += [
    '-m32',
    '-ldl',
    '-lm',
    '-Wl,--gc-sections',
    '-Wl,--as-needed',
    '-Wl,--no-undefined',
  ]
elif builder.cxx.target.platform == 'windows':
  # Windows defines
  builder.cxx.defines += [
    '_CRT_SECURE_NO_DEPRECATE',
    '_CRT_SECURE_NO_WARNINGS',
    '_CRT_NONSTDC_NO_DEPRECATE',
    'NOMINMAX',
    'WIN32',
    '_WINDOWS'
  ]
  # Windows compiler C flags
  builder.cxx.cflags += [
    '/W3',
    '/GS-',
    '/Gy',
  ]
  # Windows compiler C++ flags
  builder.cxx.cxxflags += [
    '/std:c++17',
    '/arch:SSE2',
    '/fp:fast',
    '/EHsc',
    '/GR-',
  ]
  # Windows linker flags
  builder.cxx.linkflags += [
    '/EXPORT:GiveFnptrsToDll=_GiveFnptrsToDll@8,@1',
    '/SECTION:.data,RW',
    '/MACHINE:X86',
  ]

# Compiler options for optimization ( --enable-optimize )
if builder.options.optimize == '1':
  # Shared optimization definitions
  builder.cxx.defines += ['NDEBUG']
  if builder.cxx.target.platform == 'linux':
    # Linux optimization flags
    builder.cxx.cflags += [
      '-O2',
      '-flto=auto',
    ]
    # LTO must be in link flags too - [APG]RoboCop[CL]
    builder.cxx.linkflags += [
      '-flto=auto',
      '-s',
      '-Wl,-z,relro,-z,now',
      '-Wl,-z,noexecstack',
    ]
  elif builder.cxx.target.platform == 'windows':
    # Windows optimization flags - /Ob2 needs to be after /O2, enables aggressive function inling -caxanga334
    builder.cxx.cflags += [
      '/O2',
      '/Ob2',
      '/Oi',
      '/Ot',
      '/GL',
      '/MD',
    ]
    # Windows optimization link flags
    builder.cxx.linkflags += [
      '/OPT:ICF',
      '/OPT:REF',
      '/LTCG',
    ]

# Compiler options for debugging ( --enable-debug )
if builder.options.debug == '1':
  # Shared debug definitions
  builder.cxx.defines += ['DEBUG', '_DEBUG']
  if builder.cxx.target.platform == 'linux':
    # Linux debug flags
    builder.cxx.cflags += ['-g3', '-O0']
  elif builder.cxx.target.platform == 'windows':
    # Windows debug flags
    builder.cxx.cflags += ['/Od', '/RTC1', '/MDd']
    # Windows debug link flags
    builder.cxx.linkflags += ['/NODEFAULTLIB:libcmt']

# Handle --enable-static-lib and --enable-shared-lib
if builder.cxx.target.platform == 'linux':
  if builder.options.staticlib:
    builder.cxx.linkflags += [
      '-static-libgcc',
      '-static-libstdc++'
    ]
  elif builder.options.sharedlib:
    builder.cxx.linkflags += [
      '-shared-libgcc',
    ]


library = builder.cxx.Library('metamod')

library.compiler.includes += include_paths

library.sources += [
	'./metamod/api_hook.cpp',
	'./metamod/api_info.cpp',
	'./metamod/commands_meta.cpp',
	'./metamod/conf_meta.cpp',
	'./metamod/dllapi.cpp',
	'./metamod/engine_api.cpp',
	'./metamod/engineinfo.cpp',
	'./metamod/game_autodetect.cpp',
	'./metamod/game_support.cpp',
	'./metamod/h_export.cpp',
	'./metamod/linkgame.cpp',
	'./metamod/linkplug.cpp',
	'./metamod/log_meta.cpp',
	'./metamod/meta_eiface.cpp',
	'./metamod/metamod.cpp',
	'./metamod/mlist.cpp',
	'./metamod/mplayer.cpp',
	'./metamod/mplugin.cpp',
	'./metamod/mreg.cpp',
	'./metamod/mutil.cpp',
	'./metamod/osdep.cpp',
	'./metamod/osdep_p.cpp',
	'./metamod/reg_support.cpp',
	'./metamod/sdk_util.cpp',
	'./metamod/studioapi.cpp',
	'./metamod/support_meta.cpp',
	'./metamod/vdate.cpp',
]

if builder.cxx.target.platform == 'linux':
  library.sources += [
    'metamod/osdep_detect_gamedll_linux.cpp',
    'metamod/osdep_linkent_linux.cpp',
  ]
  
if builder.cxx.target.platform == 'windows':
  library.sources += [
    'metamod/osdep_detect_gamedll_win32.cpp',
	'metamod/osdep_linkent_win32.cpp',
  ]

builder.Add(library)